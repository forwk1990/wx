define(["util","model","banner"],function(b,c,a){return can.Component.extend({tag:"storemenu",template:can.view(b.getView("storeMenu.mustache")),viewModel:{selectedStore:null,storeMenuList:null,adShowFlag:true,purchaseTotalNum:0,purchaseTotalPrice:0,isModify:can.compute(true),showCartBar:can.compute(function(){return this.attr("purchaseTotalNum")>0}),totalNumForShow:can.compute(function(){var d=this.attr("purchaseTotalNum");return d?(d>99?"N":d):""}),totalPriceForShow:can.compute(function(){var d=this.attr("purchaseTotalPrice");if(d){d=parseFloat(d);if(d<0){d=0}}return d.toFixed(2)}),cartTemplate:null,cartData:{},tips:null,init:function(){var d=this;d.attr("adShowFlag",Config.isShowAdvertisement);d.attr("wapper",Config.wapcontext);d.attr("selectedStore",{"storename":"餐厅加载中..."});d.loadStoreMenu({},function(e){d.initStoreMenu(e)})},loadStoreMenu:function(e,g){var d=this,f=b.getOrderInfo();c.Store.getAllMenu({key:JSON.stringify({"cloudId":f.cloudId})},function(h){g(h)});c.Store.getRestaurantName({key:JSON.stringify({"cloudId":f.cloudId})},function(h){if(h.length===1){f.cloudName=h[0].restaurantName;f.imgPath=h[0].imgPath;d.attr("selectedStore",{"storename":f.cloudName});b.saveOrderInfo(f);a.activities[1].CONTENTCN=f.cloudName+a.activities[1].CONTENTCN}else{d.attr("selectedStore",{"storename":"美食快点平台"});a.activities[1].CONTENTCN=f.cloudName+a.activities[1].CONTENTCN}d.attr("tips",a.activities)},function(){d.attr("selectedStore",{"storename":"美食快点平台"});a.activities[1].CONTENTCN=f.cloudName+a.activities[1].CONTENTCN;d.attr("tips",a.activities)})},initStoreMenu:function(e){var d=this;can.each(e,function(h,f){var i=h;var g=i.topClassHighLightFlag==1;i.purchaseCount=0;i.showCount=can.compute(function(){var j=i.purchaseCount;return j>99?"N":j});can.each(h.foodInfo,function(k,l){var j=k.foodChoice.length==0;i.foodType=k.foodtype;k.imgPath=k.foodImage;k.activeFlag=j;k.isCanBuyByTime=j;k.price=k.foodPrice;k.purchaseNum=0;k.systemId=k.id;k.topType=i.foodType;k.iMaxQty=99;k.isExpandedChildMenu=Config.isExpandedChildMenu;if(k.foodGroupStatus==1){can.each(k.foodChoice,function(n,m){n.purchaseNum=n.choiceNum;n.systemId=n.id;n.name=n.choiceName;n.price=n.choicePrice;n.activeFlag=1;n.iMaxQty=99;n.topType=k.topType})}});i.activeFlag=g;i.selected=(f==0)});d.attr("storeMenuList",e);d._render();d.refreshStoreMenuList()},getHadPurchasedNum:function(e){var g=b.getOrderInfo();var i=g.items;var h=null;$.each(i,function(j,k){if(k.systemId==e.systemId){h=k;return false}});var d=0;if(h){d=h.quantity}var f=b.getLocalTempOrders();if(f){$.each(f,function(l,j){var k=l.split("_")[1];if(k==e.systemId){d+=j.quantity}})}return d},_render:function(){$("#wrapper-main").height(window.innerHeight);var i=this.attr("adShowFlag")?70:44;var j=$(window).width();var m=j-40;var p=Config.leftMenuWidth;var n=1;$("#left-categroy").width(p);$("#left-categroy>ul.left-menu").width(p-n);$(".carte-box").width(window.innerWidth-p);$(".ad-con-js").width(m);$container=$("#wrapper-box-js");if(this.showCartBar()){$container.css("bottom",50)}else{$container.css("bottom",0)}$container.css("top",i);var e=$(".menulist"),f=document.getElementById("holder"),d=e.find("li.categoryTitle"),h=$(".left-menu>li"),k=null,l=0,g=0;f.innerText=d.eq(0).text();e.on("scroll",function(x){var t=e.scrollTop()+f.clientHeight;for(var u=0;u<d.length;u++){var s=d[u];g=t-s.offsetTop;if(u==d.length-1){if(g>0){l=u;if(g>f.clientHeight){g=0;f.innerText=s.innerText}f.style.top=""+(-g)+"px"}break}var w=d[u+1];var v=t-w.offsetTop;if(g>0&&v<0){l=u;if(g>f.clientHeight){g=0;f.innerText=s.innerText}f.style.top=""+(-g)+"px";break}}k=setTimeout(function(){clearTimeout(k);b.lazyLoad.lazy({time_out:1000});if(h.eq(l).hasClass("on")){return}h.find(".left-line").remove();h.removeClass("on").eq(l).append('<div class="left-line"></div>').addClass("on")},100)});var r=this.tips;if(r&&r.length>1){window.clearInterval(window.adInterval);window.adInterval=setInterval(function(){var t=$(".ad-con-js p").height();var s=parseInt($(".ad-con-js").css("margin-top"))-t;$(".ad-con-js").animate({"margin-top":s},1000,function(){if(s<=-($(".ad-con-js").height()-t)){$(".ad-con-js").css("margin-top","0px")}})},5000)}b.lazyLoad.lazy({time_out:1000});var q=$('<div id="pointDivs">').appendTo("#pagecontent");for(var o=0;o<5;o++){$('<div class="point-outer point-pre"><div class="point-inner"/></div>').appendTo(q)}b.Busy.stop()},_renderCart:function(){var e=b.getOrderInfo();var h=e.items;var d=e.promotions;var g=b.calculateSum();this.attr("purchaseTotalNum",g.quantity);this.attr("purchaseTotalPrice",g.price);var f=this;if(h&&h.length>0){f.cartData.attr("orderedItems",h);f.cartData.attr("promotions",d);b.Busy.stop()}else{$("#cart-box").hide();$("#cart-box").remove();this.cartTemplate=null;b.Busy.stop()}},_addProductNum:function(f,d){if(!d.activeFlag){b.showInstantMessage({content:"该产品目前无法订购，请谅解"});return}var e=d.purchaseNum;var g=parseInt(d.iMaxQty);if(e>=g){b.showInstantMessage({content:"该产品最多可订购"+g+"份"});return}this._fly();d.attr("purchaseNum",e+1);this.updateItemTopClass(d,true);this.updateLocalCartInfo(d,true)},_fly:function(){var e=$(event.target).offset();var i=window.innerHeight-40,d=30,g=e.left+10,j=e.top+10;var f=$("#pointDivs .point-pre").first().removeClass("point-pre").css({left:g+"px",top:j+"px"});var h=f.find(".point-inner");setTimeout(function(){f[0].style.webkitTransform="translate3d(0,"+(i-j)+"px,0)";h[0].style.webkitTransform="translate3d("+(d-g)+"px,0,0)";setTimeout(function(){f.removeAttr("style").addClass("point-pre");h.removeAttr("style");$("#cart-animate").animate("zoomInout",200)},550)},1)},_minusProductNum:function(e){if(!e.activeFlag){b.showInstantMessage({content:"该产品目前无法订购，请谅解"});return}var d=e.purchaseNum-1;e.attr("purchaseNum",d<0?0:d);this.updateItemTopClass(e,false);this.updateLocalCartInfo(e,false)},updateItemTopClass:function(f,e){var g=can.data(can.$(".left-menu li[toptype='"+f.topType+"']"),"categoryVo");var d=g.attr("purchaseCount");d=e?d+1:d-1;g.attr("purchaseCount",d)},updateLocalCartInfo:function(g,f){this.isModify(true);var h=this.purchaseTotalNum;var e=f?h+1:h-1;this.attr("purchaseTotalNum",e);var d=this.purchaseTotalPrice;var e=f?(d*100)+(g.price*100):(d*100)-(g.price*100);e=e/100;this.attr("purchaseTotalPrice",e)},getInfoInOrder:function(e,d){var f=false;$.each(d,function(g,h){if(h.systemId==e.systemId){f=h;return false}});return f},refreshStoreMenuList:function(){var d=this;var e=b.getOrderInfo();var g=new Array();if(e.items&&e.items.length>0){can.each(this.attr("storeMenuList"),function(h,j){var i=h;var k=0;can.each(h.attr("foodInfo"),function(n,m){if(!n.activeFlag&&n.foodGroupStatus!=1){return}if(n.foodGroupStatus!=1){var l=d.getInfoInOrder(n,e.items);if(l&&$.inArray(l.systemId,g)<0){n.attr("purchaseNum",l.quantity);g.push(l.systemId)}else{n.attr("purchaseNum",0)}k+=n.purchaseNum}else{$.each(n.foodChoice,function(o,q){var p=d.getInfoInOrder(q,e.items);if(p&&$.inArray(p.systemId,g)<0){q.attr("purchaseNum",p.quantity);n.attr("isExpandedChildMenu",true);g.push(p.systemId)}else{q.attr("purchaseNum",0)}k+=q.purchaseNum})}});i.attr("purchaseCount",k)})}else{can.each(this.attr("storeMenuList"),function(h,i){can.each(h.attr("foodInfo"),function(k,j){k.attr("purchaseNum",0);if(k.foodGroupStatus==1){k.attr("isExpandedChildMenu",false);$.each(k.foodChoice,function(l,m){m.attr("purchaseNum",0)})}});h.attr("purchaseCount",0)})}var f=b.calculateSum();this.attr("purchaseTotalNum",f.quantity);this.attr("purchaseTotalPrice",f.price)},triggerCart:function(){if($("#cart-box").length>0&&"block"==$("#cart-box").css("display")){$("#cart-box").hide();$("#cart-box").remove();this.cartTemplate=null;return false}var d=this;if(!d.cartTemplate){d.cartTemplate=can.view(b.getView("storeMenu.cartInfo.mustache"),d.cartData);$("#wrapper-main").append(d.cartTemplate)}var e=null;$("#cart-box").show();$("#cart-box").css({"position":"absolute","top":0,"bottom":0,"width":"100%"}).on("touchstart",function(h){e=h.touches[0].clientY}).on("touchmove",function(i){var h=i.target.className;if(h=="layer-box01"){i.preventDefault();return false}if(i.touches[0].clientY<e){if($(".ow-y").scrollTop()>=$(".ow-y")[0].scrollHeight-$(".ow-y").height()){i.preventDefault();return false}}else{if($(".ow-y").scrollTop()==0){i.preventDefault();return false}}});b.Busy.start();if(d.isModify()){var g=d.genSyncOrderItems();var f=b.getOrderInfo();f.items=g;b.saveOrderInfo(f);d.isModify(false);b.removeLocalTempOrders()}d._renderCart();return false},closeAd:function(e,f,d){d.preventDefault();this.attr("adShowFlag",false);return false},settlement:function(f,g,e){var d=this;b.Busy.start();if(this.isModify()){var i=d.genSyncOrderItems();var h=b.getOrderInfo();h.items=i;b.saveOrderInfo(h);d.isModify(false);b.removeLocalTempOrders()}window.clearInterval(window.adInterval);b.Route.route(this,{page:"order",func:"tallyup"});e.preventDefault();return false},genSyncOrderItems:function(){var f=b.getOrderInfo();var e=new Array();var d=this;var g={};can.each(d.attr("storeMenuList"),function(i,h){can.each(i.attr("foodInfo"),function(j,l){var k=j.attr("purchaseNum");if(k){g[j.systemId]={mealFlag:(j.mFlag=="M"),systemId:j.systemId,price:j.price,quantity:k,modify:false,nameCN:j.foodName,id:undefined}}else{if(j.foodGroupStatus==1){can.each(j.foodChoice,function(o,m){var n=o.attr("purchaseNum");if(n){g[o.systemId]={mealFlag:true,systemId:o.systemId,price:o.price,quantity:n,modify:false,nameCN:o.name,id:undefined}}})}}})});if(f&&f.items&&f.items.length>0){can.each(f.items,function(i){var h=i.promotionType!=0;if(!h){if(g[i.systemId]){var j=g[i.systemId];if(j.quantity==i.quantity){delete g[i.systemId]}else{j.modify=true;j.id=i.id}}else{g[i.systemId]={mealFlag:i.mealFlag,systemId:i.systemId,price:i.price,quantity:0,modify:true,nameCN:i.nameCN,id:i.id}}}})}$.each(g,function(h,i){e.push(i)});return e},updateCartOrderItem:function(d,f){var e=this;var g=b.getOrderInfo();$.each(g.items,function(h,i){if(i.systemId===d.systemId){if(!f&&d.quantity===0){g.items=g.items.slice(0,h).concat(g.items.slice(h+1))
}else{i.quantity=d.quantity}return false}});e.modifyStoreMenuList(d,f);e._renderCart()},modifyStoreMenuList:function(d,h){var i=false;var e=this;var k=can.$("li[systemId='"+d.systemId+"']");if(k.length>0){for(var g=0;g<k.length;g++){var j=can.data(can.$("li[systemId='"+d.systemId+"']").eq(g),"menuVo");if(j.purchaseNum){var f=j.attr("purchaseNum");f=h?f+1:f-1;j.attr("purchaseNum",f);e.updateItemTopClass(j,h);i=true;break}}}if(!i){console.info("没有找到对应可用的菜单项")}}},helpers:{isShowCartBar:function(d){var e=this.attr("adShowFlag")?70:44,f=$("#wrapper-box-js");if(this.showCartBar()){$(".order-layer").removeClass("hideCartBar").addClass("showCartBar");f.css("bottom",50)}else{$(".order-layer").removeClass("showCartBar").addClass("hideCartBar");f.css("bottom",0)}f.css("top",e)},showCountF:function(e){var d=e;if(can.isFunction(e)){d=e()}return d>99?"N":d}},events:{"#pr-lay-close-js tap":function(){$("#pic_cover").hide();$("#pic_cover").remove();return false},"#layer-box02-js tap":function(e,d){var f=d.gesture.target.id;if(f!="layer-box02-js"){return false}$("#pic_cover").hide();$("#pic_cover").remove();return false},".pr-pic tap":function(f,i){var e=can.data($(f).parent().parent().parent(),"menuVo");e.attr("isExpandedChildMenu",true);var j=can.view(b.getView("storeMenu.popWindow.mustache"),e);can.$("#wrapper-main").append(j);var d=$(document).height();var g=$(document).width();$(".pr_lay").css("height",d-40);$(".pr_lay").css("width",g-40);$(".pr_lay").css("left",20);$(".img-box").height(g-40);$("#popContent").height(d-70);$("#pic_cover").show();$("#pic_cover img").attr("src",$("#pic_cover img").attr("real_src")).removeAttr("real_src");var h=null;$("#pic_cover").on("touchstart",function(k){h=k.touches[0].clientY;console.info("start->"+h)}).on("touchmove",function(l){var k=l.target.className;console.info("move->"+k);if(k=="layer-box02"){l.preventDefault();console.info("return false move->"+k);return false}if(l.touches[0].clientY<h){if($(".nostyle").scrollTop()>=$(".nostyle")[0].scrollHeight-$(".nostyle").height()){l.preventDefault();console.info("return false move->"+k);return false}}else{if($(".nostyle").scrollTop()==0){l.preventDefault();console.info("return false move->"+k);return false}}})},".left-menu li tap":function(d,e){var f=$(d);var g=$(".menulist>li.categoryTitle").filter("li[toptype='"+f.attr("toptype")+"']");$(".menulist").scrollTop(g[0].offsetTop);f.siblings().find(".left-line").remove();f.siblings().removeClass("on");f.append('<div class="left-line"></div>').addClass("on")},".listAdd tap":function(e,f){var d=can.data(can.$(e).parent().parent().parent().parent(),"menuVo");this.scope._addProductNum(f,d)},".listMinus tap":function(e,f){var d=can.data(can.$(e).parent().parent().parent().parent(),"menuVo");this.scope._minusProductNum(d)},".popAdd tap":function(f,e){var d=can.data(can.$(f).parent().parent().parent(),"menuVo");this.scope._addProductNum(e,d);return false},".popMinus tap":function(f,e){var d=can.data(can.$(f).parent().parent().parent(),"menuVo");this.scope._minusProductNum(d);return false},".expandAdd tap":function(e,f){var d=can.data(can.$(e).parent().parent(),"menuVo");this.scope._addProductNum(f,d)},".expandMinus tap":function(e,f){var d=can.data(can.$(e).parent().parent(),"menuVo");this.scope._minusProductNum(d)},".cartAdd tap":function(e,f){var d=can.data(can.$(e).parent().parent(),"orderItem");if(d.quantity>=99){b.showInstantMessage({content:"同一产品最多订99份。"});return}d.quantity=d.quantity+1;this.scope.updateCartOrderItem(d,true)},"{window} resize":function(){$("#wrapper-main").height(window.innerHeight);$("#wrapper-box-js").height(window.innerHeight-43).css({"margin-top":"43px","padding-bottom":"0px"});$(".carte-box").css("padding-bottom","0px");$(".carte-box").width(window.innerWidth-101);if(this.scope.showCartBar()){$("#wrapper-box-js").height(window.innerHeight-93).css("padding-bottom","50px")}else{$("#wrapper-box-js").height(window.innerHeight-43).css("padding-bottom","0px")}},".cartMinus tap":function(e){var d=can.data(can.$(e).parent().parent(),"orderItem");d.quantity=d.quantity-1;d.quantity=d.quantity<0?0:d.quantity;this.scope.updateCartOrderItem(d,false)},".pr-expand tap":function(e){var d=can.data(can.$(e).parent().parent().parent(),"menuVo");var f=d.attr("isExpandedChildMenu");d.attr("isExpandedChildMenu",!f)},"#layer-box01-js tap":function(){$("#cart-box").hide();$("#cart-box").remove();this.scope.cartTemplate=null;return false},"#emptyCart tap":function(){var d=this;b.confirm({description:"确认清空购物车？"},function(){b.Busy.start();var e=b.getOrderInfo();e.items=[];b.saveOrderInfo(e);$("#cart-box").hide();$("#cart-box").remove();d.scope.cartTemplate=null;d.scope.refreshStoreMenuList();b.Busy.stop()})}}})});